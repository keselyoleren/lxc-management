{% extends "base.html" %}

{% block content %}
<!-- Muat library Chart.js dari CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .stat-card { margin-bottom: 1.5rem; }
    .chart-container { position: relative; height: 250px; width: 100%; }
</style>

<!-- Area Notifikasi Real-time -->
<div id="notifications" class="mb-3"></div>

<!-- Dasbor Monitoring Host -->
<h3 class="mb-3">Server Status</h3>
<div class="row">
    <!-- CPU Usage -->
    <div class="col-lg-4 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">CPU Usage</h5>
                <p class="card-text fs-2 fw-bold" id="cpu-usage-text">0.0%</p>
                <div class="progress" style="height: 10px;">
                    <div id="cpu-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- RAM Usage -->
    <div class="col-lg-4 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">RAM Usage</h5>
                <p class="card-text fs-2 fw-bold" id="ram-usage-text">0%</p>
                <small class="text-muted" id="ram-usage-details">0.0 GB / 0.0 GB</small>
                <div class="progress mt-2" style="height: 10px;">
                    <div id="ram-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Disk Usage -->
    <div class="col-lg-4 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title">Root Disk Usage</h5>
                <p class="card-text fs-2 fw-bold" id="disk-usage-text">0%</p>
                <small class="text-muted" id="disk-usage-details">0.0 GB / 0.0 GB</small>
                <div class="progress mt-2" style="height: 10px;">
                    <div id="disk-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grafik Real-time -->
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">CPU Usage History</h5>
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Memory Usage History</h5>
                <div class="chart-container">
                    <canvas id="ramChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="my-4">

<!-- Bagian Manajemen Container (tidak berubah) -->
<div class="row mt-4">
    <div class="col-md-4">
        <h3>Create New Container</h3>
        <!-- Form pembuatan container -->
        <div class="card"><div class="card-body"><form id="create-container-form">
            <div class="mb-3"><label for="name" class="form-label">Container Name</label><input type="text" class="form-control" id="name" name="name" required></div>
            <div class="mb-3"><label for="template" class="form-label">Template</label><input type="text" class="form-control" id="template" name="template" value="ubuntu" readonly></div>
            <div class="mb-3"><label for="ram_limit" class="form-label">RAM Limit (MB)</label><input type="number" class="form-control" id="ram_limit" name="ram_limit" placeholder="Contoh: 512" min="64"></div>
            <div class="mb-3"><label for="cpu_limit" class="form-label">CPU Cores</label><input type="number" class="form-control" id="cpu_limit" name="cpu_limit" placeholder="Contoh: 1" min="1"></div>
            <button type="submit" class="btn btn-primary w-100 d-flex align-items-center justify-content-center"><span id="create-btn-text">Create</span><div id="create-btn-spinner" class="spinner-border spinner-border-sm d-none" role="status"></div></button>
        </form></div></div>
    </div>
    <div class="col-md-8">
        <h3>Existing Containers</h3>
        <!-- Tabel container -->
        <div class="table-responsive"><table class="table table-striped table-hover align-middle"><thead class="table-dark"><tr><th>Name</th><th>State</th><th>IP Address</th><th>RAM Limit</th><th>CPU Cores</th><th>Actions</th></tr></thead><tbody id="container-table-body">
            {% for c in containers %}<tr id="container-row-{{ c.name }}"><td class="container-name">{{ c.name }}</td><td class="container-state"></td><td class="container-ips">{{ c.ips | join(', ') if c.ips else 'N/A' }}</td><td class="container-ram">{{ c.ram_limit }}</td><td class="container-cpu">{{ c.cpu_limit }}</td>
            <td class="container-actions">
                <div class="btn-group" role="group">
                    <form action="/container/{{ c.name }}/start" method="post" class="d-inline"><button type="submit" class="btn btn-sm btn-outline-success btn-start">Start</button></form>
                    <form action="/container/{{ c.name }}/stop" method="post" class="d-inline"><button type="submit" class="btn btn-sm btn-outline-warning btn-stop">Stop</button></form>
                    <!-- Tombol Console Baru -->
                    <a href="/container/{{ c.name }}/console" target="_blank" class="btn btn-sm btn-outline-primary btn-console" role="button">Console</a>
                    <form action="/container/{{ c.name }}/destroy" method="post" class="d-inline" onsubmit="return confirm('Anda yakin ingin menghapus permanen container ini?');"><button type="submit" class="btn btn-sm btn-outline-danger btn-destroy">Destroy</button></form>
                </div>
            </td>
            <script>document.addEventListener('DOMContentLoaded', function() { updateContainerRow("{{ c.name }}", { state: "{{ c.state }}", ips: {{ c.ips | tojson }} }); });</script></tr>
            {% else %}<tr id="no-containers-row"><td colspan="6" class="text-center">No containers found.</td></tr>{% endfor %}
        </tbody></table></div>
    </div>
</div>

<template id="container-row-template">
    <tr id=""><td class="container-name"></td><td class="container-state"></td><td class="container-ips">N/A</td><td class="container-ram"></td><td class="container-cpu"></td><td class="container-actions"><div class="btn-group" role="group"><form action="" method="post" class="d-inline"><button type="submit" class="btn btn-sm btn-outline-success btn-start" disabled>Start</button></form><form action="" method="post" class="d-inline"><button type="submit" class="btn btn-sm btn-outline-warning btn-stop" disabled>Stop</button></form><form action="" method="post" class="d-inline" onsubmit="return confirm('Anda yakin ingin menghapus permanen container ini?');"><button type="submit" class="btn btn-sm btn-outline-danger btn-destroy" disabled>Destroy</button></form></div></td></tr>
</template>

<!-- JavaScript Utama -->
<script>
    function updateContainerRow(name, data) {
        const row = document.getElementById(`container-row-${name}`); if (!row) return;
        const { state, ips } = data;
        const stateCell = row.querySelector('.container-state'); const ipsCell = row.querySelector('.container-ips'); const actionsCell = row.querySelector('.container-actions'); const startBtn = actionsCell.querySelector('.btn-start'); const stopBtn = actionsCell.querySelector('.btn-stop'); const destroyBtn = actionsCell.querySelector('.btn-destroy'); const consoleBtn = actionsCell.querySelector('.btn-console');
        let stateBadge = ''; const spinner = `<div class="spinner-border spinner-border-sm me-2" role="status"></div>`;
        startBtn.disabled = false; stopBtn.disabled = false; destroyBtn.disabled = false; consoleBtn.classList.remove('disabled'); actionsCell.style.opacity = 1;
        if (state === 'RUNNING') { stateBadge = `<span class="badge bg-success">RUNNING</span>`; startBtn.disabled = true; } 
        else if (state === 'STOPPED') { stateBadge = `<span class="badge bg-danger">STOPPED</span>`; stopBtn.disabled = true; consoleBtn.classList.add('disabled'); } 
        else if (state === 'STARTING' || state === 'STOPPING' || state === 'DELETING') { const badgeClass = state === 'STARTING' ? 'bg-info' : 'bg-warning'; stateBadge = `<span class="badge ${badgeClass}">${spinner}${state}</span>`; startBtn.disabled = true; stopBtn.disabled = true; destroyBtn.disabled = true; consoleBtn.classList.add('disabled'); actionsCell.style.opacity = 0.5; } 
        else { stateBadge = `<span class="badge bg-secondary">${state}</span>`; consoleBtn.classList.add('disabled'); }
        stateCell.innerHTML = stateBadge; ipsCell.textContent = Array.isArray(ips) && ips.length > 0 ? ips.join(', ') : 'N/A';
    }

    // Fungsi untuk memformat byte menjadi unit yang lebih besar (GB, MB, etc.)
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Fungsi untuk memperbarui baris container (tidak berubah)
    function updateContainerRow(name, data) {
        const row = document.getElementById(`container-row-${name}`); if (!row) return;
        const { state, ips } = data;
        const stateCell = row.querySelector('.container-state'); const ipsCell = row.querySelector('.container-ips'); const actionsCell = row.querySelector('.container-actions'); const startBtn = actionsCell.querySelector('.btn-start'); const stopBtn = actionsCell.querySelector('.btn-stop'); const destroyBtn = actionsCell.querySelector('.btn-destroy');
        let stateBadge = ''; const spinner = `<div class="spinner-border spinner-border-sm me-2" role="status"></div>`;
        startBtn.disabled = false; stopBtn.disabled = false; destroyBtn.disabled = false; actionsCell.style.opacity = 1;
        if (state === 'RUNNING') { stateBadge = `<span class="badge bg-success">RUNNING</span>`; startBtn.disabled = true; } 
        else if (state === 'STOPPED') { stateBadge = `<span class="badge bg-danger">STOPPED</span>`; stopBtn.disabled = true; } 
        else if (state === 'STARTING' || state === 'STOPPING' || state === 'DELETING') { const badgeClass = state === 'STARTING' ? 'bg-info' : 'bg-warning'; stateBadge = `<span class="badge ${badgeClass}">${spinner}${state}</span>`; startBtn.disabled = true; stopBtn.disabled = true; destroyBtn.disabled = true; actionsCell.style.opacity = 0.5; } 
        else { stateBadge = `<span class="badge bg-secondary">${state}</span>`; }
        stateCell.innerHTML = stateBadge; ipsCell.textContent = Array.isArray(ips) && ips.length > 0 ? ips.join(', ') : 'N/A';
    }

    document.addEventListener("DOMContentLoaded", function() {
        const notificationsDiv = document.getElementById('notifications');
        const createForm = document.getElementById('create-container-form');
        const tableBody = document.getElementById('container-table-body');
        const rowTemplate = document.getElementById('container-row-template');
        
        // Elemen UI untuk statistik host
        const cpuUsageText = document.getElementById('cpu-usage-text');
        const cpuProgress = document.getElementById('cpu-progress');
        const ramUsageText = document.getElementById('ram-usage-text');
        const ramUsageDetails = document.getElementById('ram-usage-details');
        const ramProgress = document.getElementById('ram-progress');
        const diskUsageText = document.getElementById('disk-usage-text');
        const diskUsageDetails = document.getElementById('disk-usage-details');
        const diskProgress = document.getElementById('disk-progress');

        // Fungsi helper untuk membuat chart
        function createChart(canvasId, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: label, data: [], borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 }, x: { display: false } }, plugins: { legend: { display: false } } }
            });
        }
        
        const cpuChart = createChart('cpuChart', 'CPU Usage (%)');
        const ramChart = createChart('ramChart', 'RAM Usage (%)');

        function addDataToChart(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset) => { dataset.data.push(data); });
            // Batasi jumlah data point agar tidak terlalu berat
            if (chart.data.labels.length > 30) {
                chart.data.labels.shift();
                chart.data.datasets.forEach((dataset) => { dataset.data.shift(); });
            }
            chart.update('quiet');
        }

        // Logika form pembuatan container (tidak berubah)
        createForm.addEventListener('submit', function(event) {
            event.preventDefault(); const formData = new FormData(createForm); const name = formData.get('name'); if (!name || document.getElementById(`container-row-${name}`)) return;
            const noContainersRow = document.getElementById('no-containers-row'); if(noContainersRow) noContainersRow.remove();
            const newRow = rowTemplate.content.cloneNode(true).querySelector('tr'); newRow.id = `container-row-${name}`; newRow.querySelector('.container-name').textContent = name; newRow.querySelector('.container-ram').textContent = formData.get('ram_limit') ? `${formData.get('ram_limit')}M` : 'Default'; newRow.querySelector('.container-cpu').textContent = formData.get('cpu_limit') || 'Default'; newRow.querySelector('.container-state').innerHTML = `<span class="badge bg-info"><div class="spinner-border spinner-border-sm me-2" role="status"></div>CREATING</span>`; tableBody.prepend(newRow);
            fetch('/create', { method: 'POST', body: formData }); createForm.reset();
        });

        // Koneksi WebSocket
        const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`);
        ws.onmessage = function(event) {
            try {
                const message = JSON.parse(event.data);
                
                if (message.type === 'host_stats') {
                    const stats = message.data;
                    // Update CPU
                    cpuUsageText.textContent = `${stats.cpu.toFixed(1)}%`;
                    cpuProgress.style.width = `${stats.cpu}%`;
                    cpuProgress.setAttribute('aria-valuenow', stats.cpu);
                    // Update RAM
                    ramUsageText.textContent = `${stats.ram.percent.toFixed(1)}%`;
                    ramUsageDetails.textContent = `${formatBytes(stats.ram.used)} / ${formatBytes(stats.ram.total)}`;
                    ramProgress.style.width = `${stats.ram.percent}%`;
                    ramProgress.setAttribute('aria-valuenow', stats.ram.percent);
                    // Update Disk
                    diskUsageText.textContent = `${stats.disk.percent.toFixed(1)}%`;
                    diskUsageDetails.textContent = `${formatBytes(stats.disk.used)} / ${formatBytes(stats.disk.total)}`;
                    diskProgress.style.width = `${stats.disk.percent}%`;
                    diskProgress.setAttribute('aria-valuenow', stats.disk.percent);

                    // Update Charts
                    const timeLabel = new Date().toLocaleTimeString();
                    addDataToChart(cpuChart, timeLabel, stats.cpu);
                    addDataToChart(ramChart, timeLabel, stats.ram.percent);

                } else if (message.type === 'status_update') {
                    updateContainerRow(message.data.name, message.data);
                } else if (message.type === 'creation_complete') {
                    const { name, ram_limit, cpu_limit } = message.data; const row = document.getElementById(`container-row-${name}`); if (!row) return;
                    row.querySelector('.container-ram').textContent = ram_limit; row.querySelector('.container-cpu').textContent = cpu_limit;
                    row.querySelectorAll('form').forEach(form => { const action = form.getAttribute('action').split('/').pop(); form.setAttribute('action', `/container/${name}/${action}`); });
                    updateContainerRow(name, message.data);
                } else if (message.type === 'creation_failed' || message.data.state === 'DELETED') {
                    const name = message.data.name; const row = document.getElementById(`container-row-${name}`); if (row) row.remove();
                } else if (message.type === 'notification') {
                    const alertElement = document.createElement('div'); alertElement.className = 'alert alert-info alert-dismissible fade show'; alertElement.role = 'alert';
                    alertElement.innerHTML = `${message.data.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
                    notificationsDiv.prepend(alertElement);
                }
            } catch (e) {
                console.error("Failed to parse WebSocket message:", e);
            }
        };
    });
</script>
{% endblock %}
