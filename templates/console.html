<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Console: {{ container_name }}</title>
    <!-- Muat Xterm.js dan Addon Fit -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #000; }
        #terminal { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="terminal"></div>

    <script>
        const containerName = "{{ container_name }}";
        const term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#000000',
                foreground: '#FFFFFF',
            }
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/console/${containerName}`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            term.writeln('--- WebSocket Connection Established ---');
            ws.send(JSON.stringify({ type: 'resize', data: { cols: term.cols, rows: term.rows } }));
        };

        ws.onmessage = async function(event) {
            if (event.data instanceof Blob) {
                const data = new Uint8Array(await event.data.arrayBuffer());
                term.write(data);
            } else {
                term.write(event.data);
            }
        };

        ws.onerror = function(event) {
            term.writeln('\r\n--- WebSocket Connection Error ---');
            console.error('WebSocket Error:', event);
        };

        ws.onclose = function(event) {
            term.writeln('\r\n--- WebSocket Connection Closed ---');
        };

        term.onData(data => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'stdin', data: data }));
            }
        });

        // Handle resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        term.onResize(({ cols, rows }) => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'resize', data: { cols: cols, rows: rows } }));
            }
        });
    </script>
</body>
</html>
